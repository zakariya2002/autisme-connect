import { NextResponse } from 'next/server';
import Stripe from 'stripe';
import { createClient } from '@supabase/supabase-js';
import { Resend } from 'resend';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY || '');
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const supabase = createClient(supabaseUrl, supabaseServiceKey);
const resend = new Resend(process.env.RESEND_API_KEY);

// Fonction pour g√©n√©rer un code PIN s√©curis√©
function generateSecurePIN(): string {
  const forbidden = [
    '0000', '1111', '2222', '3333', '4444',
    '5555', '6666', '7777', '8888', '9999',
    '1234', '4321', '0123', '9876'
  ];

  let pin: string;
  do {
    pin = Math.floor(1000 + Math.random() * 9000).toString();
  } while (forbidden.includes(pin));

  return pin;
}

// Fonction pour ajouter des heures √† une date
function addHours(date: Date, hours: number): Date {
  const result = new Date(date);
  result.setHours(result.getHours() + hours);
  return result;
}

// CORS headers for mobile app
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
};

// Handle preflight OPTIONS request
export async function OPTIONS() {
  return NextResponse.json({}, { headers: corsHeaders });
}

export async function POST(request: Request) {
  try {
    const {
      educatorId,
      familyId,
      childId,
      appointmentDate,
      startTime,
      endTime,
      locationType,
      address,
      familyNotes,
      price
    } = await request.json();

    console.log('üì± [Mobile] Cr√©ation RDV avec PaymentIntent:', {
      educatorId,
      familyId,
      childId,
      price
    });

    const appUrl = process.env.APP_URL || process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';

    // Valider les donn√©es
    if (!educatorId || !familyId || !appointmentDate || !startTime || !endTime || !price) {
      return NextResponse.json(
        { error: 'Donn√©es manquantes' },
        { status: 400, headers: corsHeaders }
      );
    }

    // R√©cup√©rer les infos famille
    const { data: familyProfile, error: familyError } = await supabase
      .from('family_profiles')
      .select('id, first_name, last_name, user_id')
      .eq('id', familyId)
      .single();

    if (familyError || !familyProfile) {
      console.error('‚ùå Famille introuvable:', familyError);
      return NextResponse.json(
        { error: 'Famille introuvable' },
        { status: 404, headers: corsHeaders }
      );
    }

    // R√©cup√©rer l'email de la famille
    const { data: familyUserData } = await supabase.auth.admin.getUserById(
      familyProfile.user_id
    );
    const familyEmail = familyUserData?.user?.email;

    if (!familyEmail) {
      return NextResponse.json(
        { error: 'Email famille introuvable' },
        { status: 404, headers: corsHeaders }
      );
    }

    // R√©cup√©rer les infos √©ducateur
    const { data: educatorProfile, error: educatorError } = await supabase
      .from('educator_profiles')
      .select('id, first_name, last_name, user_id')
      .eq('id', educatorId)
      .single();

    if (educatorError || !educatorProfile) {
      console.error('‚ùå √âducateur introuvable:', educatorError);
      return NextResponse.json(
        { error: '√âducateur introuvable' },
        { status: 404, headers: corsHeaders }
      );
    }

    // Cr√©er ou r√©cup√©rer le customer Stripe pour la famille
    let customerId: string;

    const customers = await stripe.customers.list({
      email: familyEmail,
      limit: 1
    });

    if (customers.data.length > 0) {
      customerId = customers.data[0].id;
      console.log('‚úÖ Customer Stripe existant:', customerId);
    } else {
      const customer = await stripe.customers.create({
        email: familyEmail,
        metadata: {
          family_id: familyId,
          user_id: familyProfile.user_id,
        },
      });
      customerId = customer.id;
      console.log('‚úÖ Customer Stripe cr√©√©:', customerId);
    }

    // Calculer les montants (en centimes)
    const priceInCents = Math.round(price * 100);
    const commissionAmount = Math.round(priceInCents * 0.10); // 10%
    const stripeFees = Math.round(priceInCents * 0.014 + 25); // 1.4% + 0.25‚Ç¨
    const educatorAmount = priceInCents - commissionAmount - stripeFees;

    // Cr√©er un PaymentIntent avec capture manuelle (pour le SDK mobile natif)
    const paymentIntent = await stripe.paymentIntents.create({
      amount: priceInCents,
      currency: 'eur',
      customer: customerId,
      capture_method: 'manual', // Important : capture manuelle apr√®s la s√©ance
      metadata: {
        educator_id: educatorId,
        family_id: familyId,
        child_id: childId || '',
        appointment_date: appointmentDate,
        start_time: startTime,
        end_time: endTime,
        location_type: locationType,
        address: address || '',
        family_notes: familyNotes || '',
        commission_amount: commissionAmount.toString(),
        stripe_fees: stripeFees.toString(),
        educator_amount: educatorAmount.toString(),
        source: 'mobile_app',
      },
      description: `S√©ance avec ${educatorProfile.first_name} ${educatorProfile.last_name} le ${new Date(appointmentDate).toLocaleDateString('fr-FR')} √† ${startTime}`,
    });

    console.log('‚úÖ PaymentIntent cr√©√©:', paymentIntent.id);

    // Cr√©er une cl√© √©ph√©m√®re pour le customer (n√©cessaire pour le Payment Sheet)
    const ephemeralKey = await stripe.ephemeralKeys.create(
      { customer: customerId },
      { apiVersion: '2024-04-10' }
    );

    // Cr√©er le rendez-vous IMM√âDIATEMENT avec statut PENDING (en attendant la confirmation du paiement)
    // Le webhook confirmera le paiement et passera le statut √† ACCEPTED
    try {
      const pinCode = generateSecurePIN();
      const scheduledDate = new Date(`${appointmentDate}T${startTime}`);
      const pinExpiresAt = addHours(scheduledDate, 2);

      console.log('üîê Code PIN g√©n√©r√©:', pinCode);

      const { data: appointment, error: appointmentError } = await supabase
        .from('appointments')
        .insert({
          educator_id: educatorId,
          family_id: familyId,
          child_id: childId || null,
          appointment_date: appointmentDate,
          start_time: startTime,
          end_time: endTime,
          location_type: locationType,
          address: address || null,
          family_notes: familyNotes || null,
          price: priceInCents,
          status: 'accepted', // Accept√© directement
          payment_status: 'authorized',
          pin_code: pinCode,
          pin_code_expires_at: pinExpiresAt.toISOString(),
          pin_code_attempts: 0,
          pin_code_validated: false,
          stripe_payment_intent_id: paymentIntent.id,
        })
        .select()
        .single();

      if (appointmentError) {
        console.error('‚ùå Erreur cr√©ation RDV:', appointmentError);
      } else {
        console.log('‚úÖ Rendez-vous cr√©√©:', appointment.id);

        // Envoyer les emails (m√™me logique que l'endpoint web)
        const formattedDate = new Intl.DateTimeFormat('fr-FR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }).format(scheduledDate);

        // Email √† la famille
        try {
          await resend.emails.send({
            from: process.env.RESEND_FROM_EMAIL!,
            to: familyEmail,
            subject: '‚úÖ Rendez-vous confirm√© - Votre code PIN',
            html: `
              <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #027e7e;">‚úÖ Votre rendez-vous est confirm√© !</h2>

                <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
                  <p style="margin: 5px 0;"><strong>üìÖ Date :</strong> ${formattedDate}</p>
                  <p style="margin: 5px 0;"><strong>üë®‚Äçüè´ Professionnel :</strong> ${educatorProfile.first_name} ${educatorProfile.last_name}</p>
                  ${address ? `<p style="margin: 5px 0;"><strong>üìç Lieu :</strong> ${address}</p>` : ''}
                  ${locationType === 'online' ? '<p style="margin: 5px 0;"><strong>üíª Mode :</strong> En ligne</p>' : ''}
                </div>

                <div style="background: #d1fae5; border-left: 4px solid #027e7e; padding: 20px; margin: 20px 0;">
                  <h3 style="margin-top: 0; color: #027e7e;">üîê Votre code PIN</h3>
                  <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; margin: 15px 0;">
                    <div style="font-size: 48px; font-weight: bold; letter-spacing: 10px; color: #027e7e;">
                      ${pinCode}
                    </div>
                  </div>
                  <p style="margin: 10px 0;"><strong>‚ö†Ô∏è IMPORTANT :</strong> Donnez ce code au professionnel au d√©but du rendez-vous.</p>
                </div>

                <p style="font-size: 12px; color: #9ca3af; text-align: center; margin-top: 30px;">
                  NeuroCare - R√©serv√© depuis l'application mobile
                </p>
              </div>
            `
          });
          console.log('‚úÖ Email famille envoy√©');
        } catch (emailError) {
          console.error('‚ö†Ô∏è Erreur envoi email famille:', emailError);
        }

        // Email √† l'√©ducateur
        try {
          const { data: educatorUserData } = await supabase.auth.admin.getUserById(
            educatorProfile.user_id
          );
          const educatorEmail = educatorUserData?.user?.email;

          if (educatorEmail) {
            await resend.emails.send({
              from: process.env.RESEND_FROM_EMAIL!,
              to: educatorEmail,
              subject: 'üéâ Nouveau rendez-vous confirm√©',
              html: `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                  <h2 style="color: #027e7e;">üéâ Nouveau rendez-vous !</h2>

                  <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <p style="margin: 5px 0;"><strong>üìÖ Date :</strong> ${formattedDate}</p>
                    <p style="margin: 5px 0;"><strong>üë®‚Äçüë©‚Äçüë¶ Famille :</strong> ${familyProfile.first_name} ${familyProfile.last_name}</p>
                    ${address ? `<p style="margin: 5px 0;"><strong>üìç Lieu :</strong> ${address}</p>` : ''}
                  </div>

                  <div style="background: #d1fae5; border-left: 4px solid #027e7e; padding: 20px; margin: 20px 0;">
                    <h3 style="margin-top: 0; color: #027e7e;">üîê Code PIN requis</h3>
                    <p>Demandez le code PIN √† 4 chiffres √† la famille au d√©but du rendez-vous.</p>
                  </div>

                  <p style="font-size: 12px; color: #9ca3af; text-align: center; margin-top: 30px;">
                    NeuroCare - R√©serv√© depuis l'application mobile
                  </p>
                </div>
              `
            });
            console.log('‚úÖ Email √©ducateur envoy√©');
          }
        } catch (emailError) {
          console.error('‚ö†Ô∏è Erreur envoi email √©ducateur:', emailError);
        }
      }
    } catch (err) {
      console.error('‚ùå Erreur cr√©ation RDV:', err);
    }

    // Retourner les informations n√©cessaires pour le Payment Sheet natif
    return NextResponse.json({
      paymentIntent: paymentIntent.client_secret,
      ephemeralKey: ephemeralKey.secret,
      customer: customerId,
      publishableKey: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
    }, { headers: corsHeaders });

  } catch (error: any) {
    console.error('‚ùå Erreur cr√©ation PaymentIntent mobile:', error);
    return NextResponse.json(
      { error: error.message || 'Erreur lors de la cr√©ation du paiement' },
      { status: 500, headers: corsHeaders }
    );
  }
}
